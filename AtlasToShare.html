<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Atlas</title>
<style>
:root{
  /* Warm, calm palette (Claude x Monarch vibe) */
  --page:#f5f3ef;
  --card:#ffffff;
  --card2:#fbfaf7;
  --bg2:#f3f2ee;
  --bdr:rgba(17,24,39,.08);
  --bdr2:rgba(17,24,39,.06);
  --tx:#111827;
  --tx2:#374151;
  --tx3:#6b7280;
  --ib:rgba(17,24,39,.12);
  --foc:#4c6ef5;
  --fb:rgba(76,110,245,.10);

  --grn:#2f7a4d;
  --gb:#2f7a4d;
  --gbg:#e7f3ea;

  --red:#b42318;
  --rbg:#fff1f2;

  /* Product header tints */
  --c1:#1d4ed8; --c1b:#f4f7ff; --c1d:#dbe7ff;
  --c2:#6d28d9; --c2b:#f6f3ff; --c2d:#e0d7ff;
  --c3:#9a3412; --c3b:#fff7ed; --c3d:#fed7aa;
  --c4:#047857; --c4b:#ecfdf5; --c4d:#bff0df;

  --star:#f2b705;

  --sans: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
  --r:12px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:var(--sans);background:var(--page);color:var(--tx);height:100vh;overflow:hidden;font-size:14px;}
header{display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:44px;background:var(--card);border-bottom:1px solid var(--bdr);}
.logo{font-weight:800;font-size:16px;letter-spacing:.2px;display:flex;gap:10px;align-items:baseline;}
.tagline{font-weight:500;font-size:11px;font-style:italic;color:var(--tx3);}.logo b{color:var(--foc);}
.hdr-r{display:flex;align-items:center;gap:14px;}
.tmr{font-size:18px;font-weight:700;color:var(--tx3);font-variant-numeric:tabular-nums;}.tmr.on{color:var(--gb);}
.upd{font-size:12px;font-weight:700;color:var(--tx3);font-variant-numeric:tabular-nums;}
.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:rgba(17,24,39,.92);color:#fff;padding:10px 12px;border-radius:999px;font-size:12px;font-weight:700;letter-spacing:.01em;opacity:0;pointer-events:none;transition:opacity .16s ease, transform .16s ease;z-index:9999;max-width:80vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.toast.on{opacity:1;transform:translateX(-50%) translateY(-2px);}
.btn{padding:5px 16px;border:1.5px solid var(--bdr);background:#fff;color:var(--tx2);border-radius:10px;cursor:pointer;font-size:12px;font-weight:600;font-family:var(--sans);}.btn:hover{border-color:rgba(76,110,245,.55);color:var(--foc);box-shadow:0 1px 2px rgba(0,0,0,.04);}

.status{
  margin-left:14px;
  padding:6px 10px;
  border:1px solid var(--bdr);
  background:var(--card2);
  border-radius:999px;
  color:var(--tx2);
  font-size:12px;
  font-weight:600;
  display:flex;
  align-items:center;
  gap:10px;
  max-width:55vw;
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
}
.status .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--bdr2);background:#fff;font-size:11px;font-weight:700;color:var(--tx3);}
.status .good{color:var(--grn);} .status .bad{color:var(--red);} 

.main{display:grid;grid-template-columns:1fr 400px;height:calc(100vh - 44px);}
.sheet{overflow-y:auto;padding:18px 20px;}.sheet::-webkit-scrollbar{width:5px;}.sheet::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:3px;}

/* Inputs */
.ibar{display:flex;gap:12px;margin-bottom:16px;align-items:stretch;}
.ibar>.ig{align-self:stretch;}
.ig{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);padding:14px 14px;flex:1;box-shadow:0 1px 2px rgba(0,0,0,.035);}.ig-w{flex:1.4;}
.cashcard{display:flex;flex-direction:column;}
/* Subtraction-style comparison in Cash & Debt */
.cashcard .paycmp{margin-top:auto;padding-top:18px;max-width:260px;}
.cashcard .cmp-row{display:flex;justify-content:space-between;align-items:baseline;padding:6px 0;}
.cashcard .cmp-l{color:var(--tx3);font-weight:600;font-size:12px;letter-spacing:.02em;}
.cashcard .cmp-v{font-weight:800;font-size:18px;letter-spacing:.01em;}
.cashcard .cmp-line{border-top:2px solid rgba(17,24,39,.14);margin:6px 0 8px;}
.cashcard .cmp-change .cmp-v{font-size:19px;}
.cashcard .ltv-bar{margin-top:auto;}
.igt{font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:.14em;color:var(--tx3);margin-bottom:12px;}
.row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}.row:last-child{margin-bottom:0;}
.lbl{font-size:12px;font-weight:600;color:var(--tx2);min-width:102px;white-space:nowrap;flex-shrink:0;}
.inp{flex:1;background:#fffdf8;border:1px solid var(--ib);border-radius:10px;padding:8px 12px;color:var(--tx);font-family:var(--sans);font-size:13px;font-weight:500;outline:0;min-width:0;}.inp:focus{border-color:rgba(76,110,245,.75);box-shadow:0 0 0 3px rgba(76,110,245,.14);}.inp::placeholder{color:#9ca3af;font-weight:400;}
.inp-n{font-weight:650;text-align:right;width:112px;flex:none;font-variant-numeric:tabular-nums;}
.inp-dis{background:#f3f4f6;color:var(--tx3);cursor:default;}
select.inp{cursor:pointer;appearance:auto;}
.pct{font-size:11px;font-weight:600;color:var(--tx3);margin-left:6px;}
.ltv-bar{display:flex;gap:18px;padding-top:10px;margin-top:10px;border-top:1px solid var(--bdr2);}
.ltv-i{display:flex;align-items:baseline;gap:5px;}.ltv-l{font-size:11px;font-weight:700;color:var(--tx3);}
.lv{font-weight:750;font-size:15px;font-variant-numeric:tabular-nums;transition:color .14s ease, transform .14s ease;}.lv-ok{color:var(--grn);}.lv-w{color:var(--c3);}.lv-b{color:var(--red);}
.nta{width:100%;background:var(--card2);border:1px solid var(--ib);border-radius:12px;padding:10px 12px;color:var(--tx);font-family:var(--sans);font-size:12px;outline:0;resize:none;flex:1;min-height:140px;overflow-y:auto;box-sizing:border-box;}.nta:focus{border-color:var(--foc);}.nta::placeholder{color:#9ca3af;}

/* Products */
.products{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px;}
.prod{background:var(--card);border:1px solid var(--bdr);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 4px 10px rgba(0,0,0,.06);transition:transform .14s ease, box-shadow .14s ease, border-color .14s ease;} .prod:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(0,0,0,.09);}
.prod-h{padding:8px 10px;font-size:10.5px;font-weight:800;letter-spacing:.08em;border-bottom:1px solid;display:flex;align-items:center;gap:8px;min-height:36px;text-transform:uppercase;}
.ph1{background:var(--c1b);color:var(--c1);border-color:var(--c1d);}
.ph2{background:var(--c2b);color:var(--c2);border-color:var(--c2d);}
.ph3{background:var(--c3b);color:var(--c3);border-color:var(--c3d);}
.ph4{background:var(--c4b);color:var(--c4);border-color:var(--c4d);}
.pchk{width:14px;height:14px;accent-color:var(--foc);cursor:pointer;flex-shrink:0;}
.prod-h span{flex:1;line-height:1.2;}
.star{cursor:pointer;font-size:15px;line-height:1;color:var(--ib);flex-shrink:0;user-select:none;}.star:hover{color:var(--star);}.star.on{color:var(--star);}
.prod-b{padding:8px 10px;flex:1;}
.pr{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;gap:4px;}.pr:last-child{margin-bottom:0;}
.pr-l{font-size:10px;font-weight:500;color:var(--tx3);line-height:1.3;flex:1;}.pr-v{font-weight:700;font-size:12.5px;color:var(--tx);white-space:nowrap;}
.pri{font-weight:700;font-size:13px;text-align:right;width:60px;padding:3px 5px;border:1.5px solid var(--ib);border-radius:4px;outline:0;color:var(--tx);background:#fff;font-family:var(--sans);}.pri:focus{border-color:var(--foc);}.pri[readonly]{background:#f3f4f6;color:var(--tx3);cursor:default;border-color:var(--bdr);}
.prod-f{padding:10px 10px;background:var(--bg2);border-top:1px solid var(--bdr2);}
.pft{display:flex;align-items:baseline;justify-content:space-between;gap:4px;}.pft-l{font-size:9.5px;font-weight:700;color:var(--tx2);line-height:1.2;}.pft-v{font-weight:800;font-size:18px;white-space:nowrap;font-variant-numeric:tabular-nums;}
.pfs{display:flex;align-items:baseline;justify-content:space-between;margin-top:3px;}.pfs-l{font-size:10px;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.4px;}.pfs-v{font-weight:700;font-size:13px;}
.sv-p{color:var(--grn);}.sv-n{color:var(--red);}
.prod.best-calc{border-color:rgba(47,122,77,.45);background:linear-gradient(0deg, rgba(231,243,234,.55), rgba(231,243,234,.55));box-shadow:0 10px 24px rgba(0,0,0,.08);} .prod.best-calc .prod-f{background:rgba(231,243,234,.70);}

/* Bottom */
.bottom{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.bc{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);padding:14px 14px;box-shadow:0 1px 2px rgba(0,0,0,.03);}
.bct{font-size:10.5px;font-weight:800;text-transform:uppercase;letter-spacing:.14em;color:var(--tx3);margin-bottom:12px;}
.ccr{display:flex;align-items:center;gap:5px;margin-bottom:5px;font-size:12px;}
.ccr-l{color:var(--tx2);font-weight:500;min-width:110px;font-size:11px;white-space:nowrap;}
.ccr-inp{font-weight:600;width:60px;text-align:right;padding:3px 5px;border:1.5px solid var(--ib);border-radius:4px;outline:0;font-size:12px;color:var(--tx);font-family:var(--sans);}.ccr-inp:focus{border-color:var(--foc);}
.ccr-tog{font-size:10px;font-weight:700;padding:2px 6px;border:1.5px solid var(--bdr);border-radius:10px;cursor:pointer;color:var(--tx3);background:#fff;min-width:22px;text-align:center;}.ccr-tog:hover{border-color:var(--tx3);}
.ccr-val{font-weight:600;font-size:12px;color:var(--tx);margin-left:auto;}
.cc-help{font-size:11px;color:#9ca3af;margin:-6px 0 8px 0;line-height:1.25;}
.ccr-sp{border:0;background:transparent;cursor:default;}

.cc-tot{border-top:1.5px solid var(--bdr);padding-top:6px;margin-top:6px;display:flex;justify-content:space-between;}.cc-tot-l{font-weight:700;color:var(--tx);font-size:12px;}.cc-tot-v{font-weight:700;font-size:15px;color:var(--tx);}
.va-section{border-top:1.5px solid var(--bdr);padding-top:8px;margin-top:8px;}
.va-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;}
.va-chk{width:14px;height:14px;accent-color:var(--foc);cursor:pointer;}
.va-lbl{font-size:12px;font-weight:600;color:var(--tx2);}
.va-sel{font-size:12px;padding:3px 6px;border:1.5px solid var(--ib);border-radius:4px;outline:0;font-family:var(--sans);color:var(--tx);width:100%;}
.va-fee-d{font-size:11px;color:var(--tx3);font-weight:500;margin-top:2px;}

.dt{width:100%;border-collapse:collapse;}.dt th{font-size:10px;font-weight:700;color:var(--tx3);text-transform:uppercase;letter-spacing:.3px;text-align:left;padding:4px 5px;border-bottom:1.5px solid var(--bdr);}.dt td{padding:3px 4px;}
.dt input{width:100%;background:#fff;border:1.5px solid var(--ib);border-radius:4px;padding:4px 6px;color:var(--tx);font-family:var(--sans);font-size:12px;outline:0;}
.dt select{width:100%;background:#fff;border:1.5px solid var(--ib);border-radius:4px;padding:4px 6px;color:var(--tx);font-family:var(--sans);font-size:12px;outline:0;appearance:auto;cursor:pointer;}
.dt select:focus{border-color:var(--foc);}.dt input:focus{border-color:var(--foc);}
.dt-rm{width:22px;height:22px;background:0;border:0;color:var(--tx3);cursor:pointer;border-radius:3px;font-size:12px;display:flex;align-items:center;justify-content:center;}.dt-rm:hover{color:var(--red);background:var(--rbg);}
.d-add{background:0;border:1.5px dashed var(--bdr);color:var(--tx3);padding:3px 10px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;margin-top:5px;font-family:var(--sans);}.d-add:hover{border-color:var(--foc);color:var(--foc);}
.d-tots{margin-top:6px;padding-top:5px;border-top:1.5px solid var(--bdr);font-size:11.5px;color:var(--tx2);line-height:1.9;}.d-tots b{font-weight:700;color:var(--tx);}

/* Right */
.right{border-left:1px solid var(--bdr);display:flex;flex-direction:column;background:var(--card);min-height:0;}
.tabs{display:flex;border-bottom:1px solid var(--bdr);}.tab{flex:1;padding:10px 0;font-size:12px;font-weight:700;color:var(--tx3);cursor:pointer;border-bottom:2px solid transparent;text-align:center;}.tab:hover{color:var(--tx2);}.tab.on{color:var(--foc);border-bottom-color:var(--foc);}
.tc{flex:1;overflow:hidden;display:flex;flex-direction:column;min-height:0;}
.tp{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0;}.tp.on{display:flex;}
.draft{flex:1;padding:18px 18px;border:0;outline:0;font-family:var(--sans);font-size:13.5px;line-height:1.8;color:var(--tx);resize:none;white-space:pre-wrap;background:var(--card2);overflow-y:auto;min-height:0;;-webkit-overflow-scrolling:touch;}
.help{white-space:normal;overflow-y:auto;-webkit-overflow-scrolling:touch;touch-action:pan-y;}
.help .h1{font-size:16px;font-weight:800;margin:0 0 10px 0;}
.help .h2{font-size:14px;font-weight:800;margin:18px 0 8px 0;}
.help .h3{font-size:13px;font-weight:800;margin:14px 0 6px 0;}
.help .p{margin:0 0 10px 0;}
.help .ul{margin:0 0 12px 18px;padding:0;}
.help .ul li{margin:0 0 6px 0;}
.draft.help{overflow-y:auto;-webkit-overflow-scrolling:touch;}
.draft::placeholder{color:#9ca3af;}
/* Ensure inner panels can scroll inside flex containers (desktop-friendly) */
.tc, .tp { min-height: 0; }

/* Help panel rich text formatting */
.draft.help{
  white-space: normal;
  overflow-y: auto;
}
.draft.help h2{font-size:16px;font-weight:800;margin:0 0 10px 0;line-height:1.25;}
.draft.help h2 .sub{font-weight:700;font-size:12px;color:var(--tx3);}
.draft.help h3{font-size:13px;font-weight:800;margin:16px 0 8px 0;}
.draft.help h4{font-size:12px;font-weight:800;margin:14px 0 6px 0;color:var(--tx2);}
.draft.help p{margin:0 0 10px 0;}
.draft.help ul, .draft.help ol{margin:0 0 10px 18px;}
.draft.help li{margin:0 0 6px 0;}
.draft.help .callout{
  padding:10px 12px;
  border:1px solid var(--bdr);
  background:#fff;
  border-radius:12px;
}
.draft.help .flow{padding:8px 12px;border-left:3px solid rgba(76,110,245,.55);background:rgba(76,110,245,.06);border-radius:10px;}
.draft.help .two-paths{padding:8px 12px;background:rgba(17,24,39,.04);border-radius:10px;}
.draft.help .quote{padding:10px 12px;border-left:3px solid rgba(47,122,77,.55);background:rgba(47,122,77,.06);border-radius:10px;font-style:italic;}
.tbar{display:flex;gap:6px;padding:8px 12px;border-top:1px solid var(--bdr);background:var(--bg2);flex-shrink:0;flex-wrap:wrap;}
.tb{padding:7px 10px;border:1.5px solid var(--bdr);background:#fff;color:var(--tx);border-radius:var(--r);cursor:pointer;font-size:11px;font-weight:700;font-family:var(--sans);}.tb:hover{border-color:var(--foc);color:var(--foc);}.tb.ok{border-color:var(--gb);color:var(--grn);background:var(--gbg);}
.tb-a{border-color:var(--foc);color:var(--foc);background:var(--fb);}.tb-a:hover{background:var(--foc);color:#fff;}
.tb-o{border-color:#7c3aed;color:#7c3aed;background:#f5f3ff;}.tb-o:hover{background:#7c3aed;color:#fff;}

/* Notes card: textarea should fill card height */
.notescard{display:flex;flex-direction:column;overflow:hidden;}
.notescard .nta{flex:1;min-height:140px;resize:none;}

/* Credit score input: left align like a normal field */
#cCS{text-align:left;padding-left:12px;}


 


.atlasver{position:fixed;left:12px;bottom:10px;font-size:10px;color:var(--tx3);opacity:.85;z-index:50;}
.atlasver a{color:var(--tx3);text-decoration:none;border-bottom:1px dotted rgba(17,24,39,.25);}
.atlasver a:hover{color:var(--tx2);}
.atlasver .dot{opacity:.6;margin:0 4px;}

/* LO modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(17,24,39,.35);z-index:9999;padding:18px;}
.modal.on{display:flex;}
.modalCard{width:min(520px,100%);background:var(--card);border:1px solid var(--bdr);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.18);padding:16px;}
.modalHd{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.modalHd .t{font-weight:700;}
.modalHd .x{appearance:none;border:1px solid var(--bdr);background:var(--card2);border-radius:10px;padding:6px 10px;cursor:pointer;}
.modalGrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
.modalNote{font-size:12px;color:var(--tx3);margin-top:8px;}


</style>

<style>
.short{width:60px;text-align:center;}
.input-group{display:flex;align-items:center;gap:4px;}
</style>

</head>
<body>
<header><div class="logo">Atlas<span class="tagline">Clarity. Direction. Action.</span></div><div class="hdr-r"><div class="tmr" id="tmr">0:00</div><div class="upd" id="lastUpd" title="Last time inputs changed">Updated: —</div><button class="btn" onclick="newCall()">New Call</button></div></header>
<div class="main">
<div class="sheet">

<!-- INPUTS -->
<div class="ibar">
<div class="ig ig-w"><div class="igt">Client</div>
<div class="row"><span class="lbl">Name</span><input class="inp" id="cNm" placeholder="Full name" oninput="rc()"><div class="hint" id="nmHint" style="margin-left:8px;color:var(--tx3);font-size:11px;white-space:nowrap;"></div></div>
<div class="row"><span class="lbl">Email</span><input class="inp" id="cEm" placeholder="client@email.com" type="email"></div>
<div class="row"><span class="lbl">Property Address</span><input class="inp" id="cAddr" placeholder="123 Main Street" list="addrList" autocomplete="street-address" oninput="rc()"></div>
<datalist id="addrList"></datalist>
<div class="row"><span class="lbl">Credit Score</span><input class="inp inp-n" id="cCS" placeholder="780" oninput="rc()"></div>
<div class="row"><span class="lbl">Scenario</span><select class="inp" id="cGl" onchange="rc()"><option value="">Select...</option><option>Debt Consolidation</option><option>Cash Out</option><option>Home Improvement</option><option>Rate/Term</option><option>Shopping/Unsure</option><option>Other</option></select></div>
<div class="row"><span class="lbl">Employment</span><select class="inp" id="cW2"><option value="">Select...</option><option>W2</option><option>Self-Employed</option><option>Retired</option><option>Other</option></select></div>
</div>

<div class="ig ig-w"><div class="igt">Property & Mortgage</div>
<div class="row"><span class="lbl">Home Value</span><input class="inp inp-n" id="cHV" placeholder="$500,000" oninput="rc()"></div>
<div class="row"><span class="lbl">Mortgage Balance</span><input class="inp inp-n" id="cBal" placeholder="$100,000" oninput="rc()"></div>
<div class="row"><span class="lbl">Mortgage Payment</span><input class="inp inp-n" id="cMP" placeholder="with escrow" oninput="rc()"></div>
<div class="row"><span class="lbl">Monthly Escrow</span><input class="inp inp-n" id="cEsc" placeholder="$200" oninput="rc()"></div>
<div class="row"><span class="lbl">Max Cash @ 80% (after costs)</span><span class="lv" id="mx80">-</span></div>
<div class="row"><span class="lbl">Max Cash @ 90% (after costs)</span><span class="lv" id="mx90">-</span></div>
<div class="ltv-bar"><div class="ltv-i"><span class="ltv-l">LTV</span><span class="lv" id="dLTV">-</span></div><div class="ltv-i"><span class="ltv-l">CLTV</span><span class="lv" id="dCLTV">-</span></div></div>
</div>
<div class="ig cashcard"><div class="igt">Cash & Debt</div>
<div class="row"><span class="lbl" style="min-width:100px;">Cash Out</span><input class="inp inp-n" id="cCO" placeholder="$75,000" oninput="rc()"></div>
<div class="row"><span class="lbl" style="min-width:100px;" id="dpLbl">Monthly Debt</span><input class="inp inp-n" id="cDP" placeholder="$2,000" oninput="rc()"></div>
<div id="dpHint" style="font-size:10px;color:var(--tx3);font-style:italic;display:none;margin-bottom:4px;">Using itemized debts below</div>
<div class="paycmp" aria-label="Monthly payment comparison">
  <div class="cmp-row">
    <span class="cmp-l">Mortgage + Debt</span>
    <span class="lv cmp-v" id="curTot">-</span>
  </div>
  <div class="cmp-row">
    <span class="cmp-l">New Total</span>
    <span class="lv cmp-v" id="newTot">-</span>
  </div>
  <div class="cmp-line"></div>
  <div class="cmp-row cmp-change">
    <span class="cmp-l">Savings</span>
    <span class="lv cmp-v" id="totChg">-</span>
  </div>
</div>
</div>
<div class="ig notescard"><div class="igt">Internal Notes (not sent to client)</div><textarea class="nta" id="cNt" placeholder="Internal only..."></textarea></div>
</div>

<!-- PRODUCTS -->
<div class="products">
<div class="prod" id="pHln"><div class="prod-h ph1"><input type="checkbox" class="pchk" id="chkHln" onchange="rc()"><span>Fixed Rate Home Equity Loan</span><span class="star" data-p="hln" onclick="togStar(this)">☆</span></div>
<div class="prod-b">
<div class="pr"><span class="pr-l">Term</span><span><input class="pri" id="hlnT" value="30" oninput="rc()"><span class="pct">yr</span></span></div>
<div class="pr"><span class="pr-l">Rate</span><span><input class="pri" id="hlnR" value="8" oninput="rc()"><span class="pct">%</span></span></div>
<div class="pr"><span class="pr-l">Loan Amount<br><span style="font-size:8.5px;color:#9ca3af">Incl. financed closing costs</span></span><span class="pr-v" id="hlnLA">-</span></div>
<div class="pr"><span class="pr-l">Monthly Payment</span><span class="pr-v" id="hlnP">-</span></div>
</div>
<div class="prod-f"><div class="pft"><span class="pft-l">Monthly Housing Cost<br><span style="font-size:8.5px;font-weight:500;color:var(--tx3)">Incl. current mortgage</span></span><span class="pft-v" id="hlnTot" style="color:var(--c1)">-</span></div><div class="pfs"><span class="pfs-l">Savings</span><span class="pfs-v" id="sHln">-</span></div></div></div>

<div class="prod" id="pHlo"><div class="prod-h ph2"><input type="checkbox" class="pchk" id="chkHlo" onchange="rc()"><span>Interest Only HELOC</span><span class="star" data-p="hlo" onclick="togStar(this)">☆</span></div>
<div class="prod-b">
<div class="pr"><span class="pr-l">Term</span><span><input class="pri" id="hloT" value="10" readonly><span class="pct">yr</span></span></div>
<div class="pr"><span class="pr-l">Rate</span><span><input class="pri" id="hloR" value="8" oninput="rc()"><span class="pct">%</span></span></div>
<div class="pr"><span class="pr-l">Loan Amount<br><span style="font-size:8.5px;color:#9ca3af">Incl. financed closing costs</span></span><span class="pr-v" id="hloLA">-</span></div>
<div class="pr"><span class="pr-l">Monthly Payment</span><span class="pr-v" id="hloP">-</span></div>
</div>
<div class="prod-f"><div class="pft"><span class="pft-l">Monthly Housing Cost<br><span style="font-size:8.5px;font-weight:500;color:var(--tx3)">Incl. current mortgage</span></span><span class="pft-v" id="hloTot" style="color:var(--c2)">-</span></div><div class="pfs"><span class="pfs-l">Savings</span><span class="pfs-v" id="sHlo">-</span></div></div></div>

<div class="prod" id="pCnv"><div class="prod-h ph3"><input type="checkbox" class="pchk" id="chkCnv" checked onchange="rc()"><span>VA & Conventional Refinance</span><span class="star" data-p="cnv" onclick="togStar(this)">☆</span></div>
<div class="prod-b">
<div class="pr"><span class="pr-l">Term</span><span><input class="pri" id="cnvT" value="30" oninput="rc()"><span class="pct">yr</span></span></div>
<div class="pr"><span class="pr-l">Rate</span><span><input class="pri" id="cnvR" value="5.999" oninput="rc()"><span class="pct">%</span></span></div>
<div class="pr"><span class="pr-l">Loan Amount<br><span style="font-size:8.5px;color:#9ca3af">Incl. financed closing costs</span></span><span class="pr-v" id="cnvLA">-</span></div>
<div class="pr"><span class="pr-l">Monthly P&I</span><span class="pr-v" id="cnvP">-</span></div>
</div>
<div class="prod-f"><div class="pft"><span class="pft-l">Total Monthly Payment</span><span class="pft-v" id="cnvTot" style="color:var(--c3)">-</span></div><div class="pfs"><span class="pfs-l">Savings</span><span class="pfs-v" id="sCnv">-</span></div></div></div>

<div class="prod" id="pFha"><div class="prod-h ph4"><input type="checkbox" class="pchk" id="chkFha" onchange="rc()"><span>FHA Refinance</span><span class="star" data-p="fha" onclick="togStar(this)">☆</span></div>
<div class="prod-b">
<div class="pr"><span class="pr-l">Term</span><span><input class="pri" id="fhaT" value="30" oninput="rc()"><span class="pct">yr</span></span></div>
<div class="pr"><span class="pr-l">Rate</span><span><input class="pri" id="fhaR" value="5.25" oninput="rc()"><span class="pct">%</span></span></div>
<div class="pr"><span class="pr-l">Loan Amount<br><span style="font-size:8.5px;color:#9ca3af">Incl. financed closing costs</span></span><span class="pr-v" id="fhaLA">-</span></div>
<div class="pr"><span class="pr-l">Monthly P&I + MI</span><span class="pr-v" id="fhaP">-</span></div>
</div>
<div class="prod-f"><div class="pft"><span class="pft-l">Total Monthly Payment</span><span class="pft-v" id="fhaTot" style="color:var(--c4)">-</span></div><div class="pfs"><span class="pfs-l">Savings</span><span class="pfs-v" id="sFha">-</span></div></div></div>
</div>

<!-- BOTTOM -->
<div class="bottom">
<div class="bc"><div class="bct">Closing Cost Estimates</div>
<div class="cc-help">The closing cost percentage is based on the cash out (2nd mortgage) or the combined mortgage balance + cash out (refinance)</div>
<div class="ccr"><span class="ccr-l">Closing Costs</span>
<input class="ccr-inp" id="ccVal" value="2.5" oninput="rc()"><span class="ccr-tog" id="ccTog" onclick="togCC()">%</span><span class="ccr-val" id="ccOut">-</span></div>
<div class="ccr"><span class="ccr-l">Prepaid Escrow (months)</span><input class="ccr-inp" id="ccEscMo" value="3" oninput="rc()"><span class="ccr-tog ccr-sp" aria-hidden="true"></span><span class="ccr-val" id="ccEscOut">-</span></div>
<div style="display:none;"><span id="ccT">-</span></div>
<div class="va-section">
<div class="va-row"><input type="checkbox" class="va-chk" id="vaOn" onchange="rc()"><span class="va-lbl">VA Loan (apply VA funding fee)</span></div>
<div id="vaOpts" style="display:none;margin-top:4px;">
<div class="va-row"><select class="va-sel" id="vaType" onchange="rc()"><option value="0">Exempt (0.00%)</option><option value="0.5">IRRRL (0.50%)</option><option value="2.15">Cash-Out First Use (2.15%)</option><option value="3.3">Cash-Out Subsequent (3.30%)</option><option value="custom">Custom %</option></select></div>
<div class="va-row" id="vaCustomRow" style="display:none;"><input class="ccr-inp" id="vaCustomPct" placeholder="0" oninput="rc()" style="width:50px;"><span class="pct">%</span></div>
<div class="va-fee-d" id="vaFeeD"></div>
</div></div>
</div>

<div class="bc"><div class="bct">Debts to Be Paid Off With This Loan</div>
<table class="dt"><thead><tr><th>Liability Type</th><th style="width:90px">Balance</th><th style="width:90px">Monthly Payment</th><th style="width:24px"></th></tr></thead><tbody id="dB"></tbody></table>
<button class="d-add" onclick="addD()">+ Add</button>
<div class="d-tots"><div>Total Debt Being Paid Off: <b id="dTB">$0</b></div><div>Total Monthly Payments Eliminated: <b id="dTP">$0</b></div></div></div>
</div>

</div>

<!-- RIGHT PANEL -->
<div class="right">
<div class="tabs"><div class="tab on" onclick="stab('email',this)">Email</div><div class="tab" onclick="stab('sms',this)">SMS</div><div class="tab" onclick="stab('crm',this)">CRM</div><div class="tab" onclick="stab('help',this)">Help</div></div>
<div class="tc">
<div class="tp on" id="p-email"><textarea class="draft" id="dE" placeholder="Email draft..."></textarea></div>
<div class="tp" id="p-sms"><textarea class="draft" id="dS" placeholder="SMS draft..."></textarea></div>
<div class="tp" id="p-crm"><textarea class="draft" id="dC" placeholder="CRM notes..."></textarea></div>

<div class="tp" id="p-help">
  <div class="draft help" id="helpText" tabindex="0" role="document" aria-label="Atlas Help">
    <h2>Why Atlas Exists <span class="sub">(And Why Speed Pays)</span></h2>

    <p><b>Let’s start with something uncomfortable:</b></p>
    <p class="callout"><b>Momentum dies fast.</b></p>

    <p>The MIT / InsideSales Lead Response Management study found that the odds of contacting a lead drop dramatically when response time slips — roughly <b>100x lower</b> at 30 minutes compared to 5. Qualification odds fall hard too.</p>

    <p><b>Translation:</b><br>
    Time doesn’t “cool things off.”<br>
    Time quietly kills deals.</p>

    <p>Borrowers don’t wake up thinking,<br>
    <i>“I hate my loan officer's solution.”</i></p>

    <p>They wake up thinking:</p>
    <ul>
      <li>“I’ll look at it later.”</li>
      <li>“Maybe we should shop it.”</li>
      <li>“I forgot what the numbers were.”</li>
    </ul>

    <p>And just like that, momentum is gone.</p>

    <p><b>Atlas exists to prevent that.</b></p>
    <p>It turns:</p>
    <p class="flow"><b>Conversation → Clarity → Decision → Application</b></p>
    <p>…without the awkward “let me follow up next week.”</p>

    <h3>How Atlas Actually Makes You Money</h3>
    <p><i>Spoiler: it’s not the math.</i></p>
    <p>The math is necessary.<br>
    The <b>speed</b> is profitable.</p>

    <ol>
      <li>
        <b>Instant Clarity Builds Confidence</b>
        <p>When you run LTV, max cash at 80% / 90%, payment impact — <b>live</b> — something happens.</p>
        <p>You stop sounding like a loan officer.<br>
        You start sounding like authority.</p>
        <p>Confidence is contagious. And confidence creates the turning point — that moment when the borrower shifts from speculative to engaged.</p>
      </li>

      <li>
        <b>Structure Eliminates Rambling</b>
        <p>Atlas forces the call into a clean flow:</p>
        <p class="two-paths"><b>Keep</b> the mortgage<br><b>or</b><br><b>Replace</b> the mortgage</p>
        <p>Highlight the winner. Deliver the one‑sentence payoff. Move forward.</p>
        <p>No wandering. No “let me think about it.” No fuzzy ending. <b>Clarity reduces hesitation.</b></p>
      </li>

      <li>
        <b>The Application Is Where the Money Is</b>
        <p>This is the part people miss.</p>
        <p>The recap email is not the goal.<br>
        The soft application is not “paperwork.”<br>
        <b>It is the conversion moment.</b></p>

        <p>Atlas works best when the borrower completes the quick 5‑minute form:</p>
        <ul>
          <li>While the numbers are fresh</li>
          <li>While the confidence is high</li>
          <li>While they still feel the relief</li>
        </ul>

        <p>If you end the call and say,<br>
        “Just fill that out later,”</p>

        <p class="callout">…you’ve just handed momentum back to time.<br><b>And time is undefeated.</b></p>

        <p>The users who see the biggest lift with Atlas are the ones who move borrowers into the application immediately — on the call or right after.</p>
        <p><b>Speed to clarity</b> is good.<br>
        <b>Speed to application</b> is better.</p>
      </li>
    </ol>

    <h3>How To Use Atlas Like a Pro</h3>
    <p><b>Atlas is not a calculator.</b><br>
    It’s a momentum engine.</p>

    <h4>Phase 1: Run It Live</h4>
    <p>Enter numbers in real time. Let them see how quickly answers appear.</p>
    <p><b>Speed builds authority.</b> Authority builds trust. Trust builds action.</p>

    <h4>Phase 2: Present Two Paths</h4>
    <p>Always simplify the decision:</p>
    <p class="two-paths"><b>Keep</b> or <b>Replace</b></p>
    <p>Then clearly choose the winner.</p>
    <p>People don’t stall because they need more options.<br>
    They stall because they don’t know which option is right.<br>
    <b>Remove the ambiguity.</b></p>

    <h4>Phase 3: Move Immediately</h4>
    <p>Do not end with, “Let me know what you think.”</p>
    <p>End with direction:</p>
    <p class="quote">“I’m sending the recap now. At the bottom is a quick 5‑minute form that lets me lock this in accurately. Want to knock it out while I’m here so you’re done?”</p>

    <p>Then guide them: <b>Open → Click → Start.</b></p>
    <p>Small commitments create big outcomes.</p>

    <h3>The Philosophy</h3>
    <p><b>Momentum is perishable.</b></p>
    <p>You don’t need to push harder.<br>
    You need to move faster.</p>
    <p>Atlas doesn’t close deals for you.<br>
    It removes the delay between confidence and commitment.</p>

    <p class="callout"><b>And that gap?</b><br>
    That’s where most deals die.</p>

    <p class="flow"><b>Close the gap.</b></p>
  </div>
</div>
<div class="tbar">
<button class="tb tb-a" onclick="regen()">Regenerate</button>
<button class="tb" id="cpyBtn" onclick="cpyCur()">Copy</button>
<button class="tb tb-o" onclick="openOutlook()">Email to Client</button>
<button class="tb" onclick="emailSelf()">Email to Myself</button>
</div>
</div>
</div>

<script>
const $=id=>document.getElementById(id);

const LO_DEFAULTS = {
  name: "",
  phone: "",
  app: "",
  email: ""
};

function loadLO(){
  let data = {};
  try{ data = JSON.parse(localStorage.getItem("atlas_lo") || "{}"); }catch(e){ data = {}; }
  const lo = {
    name: (data.name || LO_DEFAULTS.name),
    phone: (data.phone || LO_DEFAULTS.phone),
    app: (data.app || LO_DEFAULTS.app),
    email: (data.email || LO_DEFAULTS.email)
  };
  if($("loName")) $("loName").value = lo.name;
  if($("loPhone")) $("loPhone").value = lo.phone;
  if($("loApp")) $("loApp").value = lo.app;
  if($("loEmail")) $("loEmail").value = lo.email;
  return lo;
}


function openLO(){
  const m = $("loModal");
  if(!m) return;
  m.classList.add("on");
  m.setAttribute("aria-hidden","false");
  // focus first field
  setTimeout(()=>{ try{ $("loName")?.focus(); }catch(e){} }, 10);
}
function closeLO(){
  const m = $("loModal");
  if(!m) return;
  m.classList.remove("on");
  m.setAttribute("aria-hidden","true");
  // optional: toast once when closing to confirm saved
  saveLO(true);
}



function getLO(){
  // prefer live inputs (so changes apply immediately)
  const lo = {
    name: ($("loName")?.value || "").trim() || LO_DEFAULTS.name,
    phone: ($("loPhone")?.value || "").trim() || LO_DEFAULTS.phone,
    app: ($("loApp")?.value || "").trim() || LO_DEFAULTS.app,
    email: ($("loEmail")?.value || "").trim() || LO_DEFAULTS.email
  };
  return lo;
}

function saveLO(silent=true){
  const lo = getLO();
  try{ localStorage.setItem("atlas_lo", JSON.stringify(lo)); }catch(e){}
  if(!silent) toast("Saved LO settings");
}

function safeNum(str){
  const s = String(str ?? '').trim();
  if(!s) return 0;

  // Excel-style quick math: "=500+700+1000" or "500+700"
  const hasOps = /[+\-*/]/.test(s);
  const expr = s.startsWith('=') ? s.slice(1) : (hasOps && /\d/.test(s) ? s : null);

  if(expr){
    const cleaned = expr.replace(/[^0-9+\-*/(). ]/g,'');
    if(cleaned && /\d/.test(cleaned)){
      try{
        // eslint-disable-next-line no-new-func
        const v = Function('return ('+cleaned+')')();
        return (typeof v==='number' && isFinite(v)) ? v : 0;
      }catch(e){/* fall through */}
    }
  }

  return parseFloat(s.replace(/[^0-9.\-]/g,''))||0;
}

const pn=v=>safeNum(v);
const fd=n=>n===0?'$0':'$'+Math.round(n).toLocaleString('en-US');

function getFirstName(fullName){
  const s=(fullName||'').trim();
  if(!s) return '';
  // Handle "Last, First"
  if(s.includes(',')){
    const parts=s.split(',').map(x=>x.trim());
    if(parts[1]) return parts[1].split(/\s+/)[0].replace(/[.,;:!?]+$/g,'');
  }
  return s.split(/\s+/)[0].replace(/[.,;:!?]+$/g,'');
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function loadAddrHistory(){
  const dl = $('addrList');
  if(!dl) return;
  const saved = JSON.parse(localStorage.getItem('addrHistory') || '[]');
  dl.innerHTML = saved.map(a => `<option value="${escapeHtml(a)}"></option>`).join('');
}
function saveAddrToHistory(v){
  const addr = (v||'').trim();
  if(!addr) return;
  let saved = JSON.parse(localStorage.getItem('addrHistory') || '[]');
  saved = saved.filter(x => String(x).toLowerCase() !== addr.toLowerCase());
  saved.unshift(addr);
  saved = saved.slice(0, 75);
  localStorage.setItem('addrHistory', JSON.stringify(saved));
  loadAddrHistory();
}

function PMT(r,n,pv){if(!r||!n)return 0;return pv*(r*Math.pow(1+r,n))/(Math.pow(1+r,n)-1);}

// Timer
let ti=null,ts=0,tS=false;
function startT(){if(ti)return;ti=setInterval(()=>{ts++;$('tmr').textContent=Math.floor(ts/60)+':'+String(ts%60).padStart(2,'0');$('tmr').classList.add('on');},1000);}
document.addEventListener('input',e=>{if(!tS&&!e.target.classList.contains('draft')){tS=true;startT();}});

// Dirty tracking
let dirty={email:false,sms:false,crm:false},aTab='email',bestStar=null;
$('dE').addEventListener('input',()=>{dirty.email=true;});
$('dS').addEventListener('input',()=>{dirty.sms=true;});
$('dC').addEventListener('input',()=>{dirty.crm=true;});

// CC mode
let ccMode='pct';
function togCC(){ccMode=ccMode==='pct'?'flat':'pct';$('ccTog').textContent=ccMode==='pct'?'%':'$';rc();}

// Star
function togStar(el){const p=el.dataset.p;if(bestStar===p){bestStar=null;}else{bestStar=p;}document.querySelectorAll('.star').forEach(s=>{s.textContent=s.dataset.p===bestStar?'★':'☆';s.classList.toggle('on',s.dataset.p===bestStar);});rc();}

// Tabs
function stab(t,el){document.querySelectorAll('.tab').forEach(e=>e.classList.remove('on'));document.querySelectorAll('.tp').forEach(e=>e.classList.remove('on'));el.classList.add('on');$('p-'+t).classList.add('on');aTab=t;}

// New call
function newCall(){clearInterval(ti);ti=null;ts=0;tS=false;$('tmr').textContent='0:00';$('tmr').classList.remove('on');
const dv={ccVal:'2.5',ccEscMo:'3',hlnT:'30',hloT:'10',cnvT:'30',fhaT:'30',hlnR:'8',hloR:'8',cnvR:'5.999',fhaR:'5.25'};
document.querySelectorAll('input:not([type=checkbox]),textarea,select').forEach(e=>{if(e.classList.contains('draft'))e.value='';else if(e.tagName==='SELECT')e.selectedIndex=0;else e.value=dv[e.id]||'';});
document.querySelectorAll('.pchk').forEach(e=>{e.checked=e.id==='chkCnv';});
$('vaOn').checked=false;bestStar=null;document.querySelectorAll('.star').forEach(s=>{s.textContent='☆';s.classList.remove('on');});
$('dB').innerHTML='';dirty={email:false,sms:false,crm:false};rc();}

// Save / Load (local, no login)
function addD(){
  const tr=document.createElement('tr');
  tr.innerHTML =
    '<td>' +
      '<select class="dt-sel" onchange="calcD()">' +
        '<option value="">Select...</option>' +
        '<option>Revolving</option>' +
        '<option>Installment</option>' +
        '<option>HELOC</option>' +
        '<option>Auto</option>' +
        '<option>Real Estate</option>' +
        '<option>Other Liability</option>' +
      '</select>' +
    '</td>' +
    '<td><input data-col="bal" placeholder="$20,000" oninput="calcD()"></td>' +
    '<td><input data-col="pmt" placeholder="$700" oninput="calcD()"></td>' +
    '<td><button class="dt-rm" onclick="this.closest(\'tr\').remove();calcD();">✕</button></td>';
  $('dB').appendChild(tr);
}

function calcD(){
  let tp=0,tb=0;
  document.querySelectorAll('#dB tr').forEach(tr=>{
    const bal = tr.querySelector('input[data-col="bal"]');
    const pmt = tr.querySelector('input[data-col="pmt"]');
    tb += pn(bal ? bal.value : 0);
    tp += pn(pmt ? pmt.value : 0);
  });
  $('dTP').textContent=fd(tp);
  $('dTB').textContent=fd(tb);
  rc();
}
function getD(){
  const d=[];
  document.querySelectorAll('#dB tr').forEach(tr=>{
    const sel = tr.querySelector('select');
    const bal = tr.querySelector('input[data-col="bal"]');
    const pmt = tr.querySelector('input[data-col="pmt"]');
    d.push({
      name: sel ? sel.value : '',
      bal: pn(bal ? bal.value : 0),
      pmt: pn(pmt ? pmt.value : 0)
    });
  });
  return d;
}
function hasItem(){return document.querySelectorAll('#dB tr').length>0;}
function getItemizedMonthlySum(){
  let t=0;
  document.querySelectorAll('#dB tr').forEach(tr=>{
    const pmt = tr.querySelector('input[data-col="pmt"]');
    t += pn(pmt ? pmt.value : 0);
  });
  return t;
}
function getDP(){
  const est = pn($('cDP').value);
  const item = getItemizedMonthlySum();
  // Use the higher of the two (do NOT add)
  return Math.max(est, item);
}


// MAIN CALC
function rc(){
// Debt monthly logic:
// Use the higher of: (1) Monthly Debt (top box) OR (2) sum of itemized monthly payments below.
// Do NOT add them together (prevents double counting).
const it = hasItem();

// VA opts
$('vaOpts').style.display=$('vaOn').checked?'block':'none';
$('vaCustomRow').style.display=$('vaType').value==='custom'?'flex':'none';

const coInput = pn($('cCO').value);

// total debt balances entered below
let debtBal = 0;
document.querySelectorAll('#dB tr').forEach(tr=>{
  const balI = tr.querySelector('input[data-col="bal"]');
  debtBal += pn(balI ? balI.value : 0);
});

// if cashout blank but debts entered → treat as debt wipe
const co = coInput > 0 ? Math.max(coInput, debtBal) : (debtBal > 0 ? debtBal : 0);
const extraCash = (coInput > 0) ? Math.max(0, co - debtBal) : 0;

const dp=getDP(),bal=pn($('cBal').value),mp=pn($('cMP').value),esc=pn($('cEsc').value),hv=pn($('cHV').value);
// LTV
if(hv>0){const l=bal/hv*100,cl=(bal+co)/hv*100;$('dLTV').textContent=l.toFixed(1)+'%';$('dLTV').className='lv '+(l<=80?'lv-ok':l<=95?'lv-w':'lv-b');$('dCLTV').textContent=cl.toFixed(1)+'%';$('dCLTV').className='lv '+(cl<=80?'lv-ok':cl<=90?'lv-w':'lv-b');}else{$('dLTV').textContent=$('dCLTV').textContent='-';$('dLTV').className=$('dCLTV').className='lv';}

// Global CC
const ccv=pn($('ccVal').value),escMo=pn($('ccEscMo').value);
const loanBase=bal+co;
const ccDollar=ccMode==='pct'?loanBase*(ccv/100):ccv;   // Refi CC base = bal + co
const cc2nd=ccMode==='pct'?(co*(ccv/100)):ccv;          // 2nd CC base = cash out only
const escDollar=esc*escMo;
$('ccOut').textContent=fd(ccDollar);$('ccEscOut').textContent=fd(escDollar);
const ccRefiTot=ccDollar+escDollar;
$('ccT').textContent=fd(ccRefiTot);

// VA fee (only on VA & Conv card)
let vaFeePct=0,vaFee=0;
if($('vaOn').checked){const vt=$('vaType').value;vaFeePct=vt==='custom'?(parseFloat($('vaCustomPct').value)||0):parseFloat(vt);}
const vaBase=bal+co+ccDollar+escDollar;
vaFee=vaBase*(vaFeePct/100);
$('vaFeeD').textContent=$('vaOn').checked?'Funding fee: '+fd(vaFee)+' ('+vaFeePct.toFixed(2)+'%)':'';

const cur=mp+dp;

// Remaining debts (assume debt payments are being paid off when cash-out is entered)
// - If itemized balances exist: require cash-out to cover balances
// - If NOT itemized: assume monthly debt entered is being paid off whenever cash-out > 0
const debtsPaidOff = (dp > 0) && (
  (debtBal > 0 && co >= debtBal) ||
  (debtBal === 0 && co > 0)
);
const remDebt = debtsPaidOff ? 0 : dp;

  // Hint under Monthly Debt (show which value is driving)
if($('dpHint')){
  const est = pn($('cDP').value);
  const item = getItemizedMonthlySum();
  const used = Math.max(est, item);
  if(est>0 || item>0){
    if(est>0 && item>0){
      $('dpHint').textContent = `Using higher of estimate (${fd(est)}) and itemized (${fd(item)}): ${fd(used)}`;
    }else if(item>0){
      $('dpHint').textContent = `Using itemized monthly debts: ${fd(item)}`;
    }else{
      $('dpHint').textContent = `Using estimated monthly debt: ${fd(est)}`;
    }
    $('dpHint').style.display='block';
  }else{
    $('dpHint').style.display='none';
  }
}

// Max cash-out @ 80% and 90% LTV (after estimated refi closing costs + escrow)
if(hv>0){
  const l80 = hv*0.80, l90 = hv*0.90;
  const gross80 = Math.max(0, l80 - bal);
  const gross90 = Math.max(0, l90 - bal);

  // approximate closing costs using max loan amount as base
  const cc80 = ccMode==='pct' ? l80*(ccv/100) : ccv;
  const cc90 = ccMode==='pct' ? l90*(ccv/100) : ccv;
  const escEst = esc*escMo;

  const net80 = Math.max(0, gross80 - cc80 - escEst);
  const net90 = Math.max(0, gross90 - cc90 - escEst);

  if($('mx80')){ $('mx80').textContent = fd(net80); $('mx80').className='lv '+(net80>0?'lv-ok':'lv'); }
  if($('mx90')){ $('mx90').textContent = fd(net90); $('mx90').className='lv '+(net90>0?'lv-ok':'lv'); }
}else{
  if($('mx80')) $('mx80').textContent='-';
  if($('mx90')) $('mx90').textContent='-';
}

// HEL: cashout + CC only (no escrow)
const hlT=pn($('hlnT').value),hlR=parseFloat($('hlnR').value)||0;
const hlL=co+cc2nd;$('hlnLA').textContent=fd(hlL);
let hlP=0,hlTot=0,hlAll=0;if(hlL>0&&hlR>0&&hlT>0){hlP=PMT(hlR/100/12,hlT*12,hlL);hlTot=hlP+mp;hlAll=hlTot+remDebt;}
$('hlnP').textContent=hlP>0?fd(hlP):'-';$('hlnTot').textContent=hlAll>0?fd(hlAll):'-';const hlS=hlAll>0?(cur-hlAll):null;

// HELOC: cashout + CC only (no escrow), IO
const hoT=pn($('hloT').value),hoR=parseFloat($('hloR').value)||0;
const hoL=co+cc2nd;$('hloLA').textContent=fd(hoL);
let hoP=0,hoTot=0,hoAll=0;if(hoL>0&&hoR>0){hoP=hoL*(hoR/100/12);hoTot=hoP+mp;hoAll=hoTot+remDebt;}
$('hloP').textContent=hoP>0?fd(hoP):'-';$('hloTot').textContent=hoAll>0?fd(hoAll):'-';const hoS=hoAll>0?(cur-hoAll):null;

// VA & Conv Refi: bal+co+cc+esc+vaFee
const cT=pn($('cnvT').value),cR=parseFloat($('cnvR').value)||0;
const cL=bal+co+ccDollar+escDollar+vaFee;$('cnvLA').textContent=fd(cL);
let cP=0,cTot=0,cAll=0;if(cL>0&&cR>0&&cT>0){cP=PMT(cR/100/12,cT*12,cL);cTot=cP+esc;cAll=cTot+remDebt;}
$('cnvP').textContent=cP>0?fd(cP):'-';$('cnvTot').textContent=cAll>0?fd(cAll):'-';const cS=cAll>0?(cur-cAll):null;

// FHA: (bal+co+cc+esc)*1.0175, NO VA fee
const fT=pn($('fhaT').value),fR=parseFloat($('fhaR').value)||0;
const fB=bal+co+ccDollar+escDollar,fL=fB*1.0175;$('fhaLA').textContent=fd(fL);
let fP=0,fTot=0,fAll=0;if(fL>0&&fR>0&&fT>0){fP=PMT(fR/100/12,fT*12,fL)+(fB*0.005)/12;fTot=fP+esc;fAll=fTot+remDebt;}
$('fhaP').textContent=fP>0?fd(fP):'-';$('fhaTot').textContent=fAll>0?fd(fAll):'-';const fS=fAll>0?(cur-fAll):null;

function showS(el,v){if(v===null){el.textContent='-';el.className='pfs-v';return;}el.textContent=(v>0?'+':'')+fd(v)+'/mo';el.className='pfs-v '+(v>0?'sv-p':'sv-n');}
showS($('sHln'),hlS);showS($('sHlo'),hoS);showS($('sCnv'),cS);showS($('sFha'),fS);

function showBE(el, cost, sv){
  if(!el){return;}
  if(!(cost>0) || !(sv>0)){ el.textContent='-'; el.className='pfs-v'; return; }
  const m = Math.max(1, Math.round(cost / sv));
  el.textContent = m + ' mo';
  el.className = 'pfs-v';
}

// Costs used for break-even (approx: fees financed)
const beCost2nd = cc2nd;
const beCostCnv = ccRefiTot + (vaFee || 0);
const beCostFha = ccRefiTot;

showBE($('beHln'), beCost2nd, hlS);
showBE($('beHlo'), beCost2nd, hoS);
showBE($('beCnv'), beCostCnv, cS);
showBE($('beFha'), beCostFha, fS);

// Monthly totals box (now vs selected product)
const nowT = cur;
let sel = null;
let chk=[]; if($('chkHln').checked)chk.push('hln'); if($('chkHlo').checked)chk.push('hlo'); if($('chkCnv').checked)chk.push('cnv'); if($('chkFha').checked)chk.push('fha');
if(chk.length===0) chk=['cnv'];
if(bestStar && chk.includes(bestStar)){ chk = chk.filter(k=>k!==bestStar); chk.unshift(bestStar); }
sel = chk[0];

let newT = 0;
if(sel==='hln') newT = (hlAll||0);
if(sel==='hlo') newT = (hoAll||0);
if(sel==='cnv') newT = (cAll||0);
if(sel==='fha') newT = (fAll||0);

if($('curTot')) $('curTot').textContent = nowT>0?fd(nowT):'-';
if($('newTot')) $('newTot').textContent = newT>0?fd(newT):'-';
if($('totChg')){
  const ch = (nowT>0 && newT>0) ? (nowT - newT) : 0;
  $('totChg').textContent = (nowT>0 && newT>0) ? ((ch>0?'+':'')+fd(ch)+'/mo') : '-';
  $('totChg').className = 'lv ' + ((nowT>0 && newT>0) ? (ch>0?'lv-ok':ch<0?'lv-b':'lv-w') : 'lv');
}

// Header status strip
try{
  const st = $('status');
  if(st){
    const fn = getFirstName($('cNm').value) || 'Client';
    const scen = ($('cGl').value||'').trim();
    const chVal = (nowT>0 && newT>0) ? (nowT - newT) : null;
    const chTxt = chVal===null ? '' : ((chVal>0?'+':'')+fd(chVal)+'/mo');
    const chCls = chVal===null ? '' : (chVal>0?'good':(chVal<0?'bad':''));
    st.innerHTML = `${fn}${scen?` <span class="pill">${escapeHtml(scen)}</span>`:''}${chVal!==null?` <span class="pill ${chCls}">${escapeHtml(chTxt)}</span>`:''}`;
  }
}catch(e){}

// Name hint (first name used in messaging)
if($('nmHint')){
  const fn = getFirstName($('cNm').value);
  $('nmHint').textContent = fn ? ('Greet: '+fn) : '';
}


// Best calc highlight
document.querySelectorAll('.prod').forEach(e=>e.classList.remove('best-calc'));
const vs=[{el:'pHln',v:hlS},{el:'pHlo',v:hoS},{el:'pCnv',v:cS},{el:'pFha',v:fS}].filter(x=>x.v!==null&&x.v>0);
if(vs.length>0){vs.sort((a,b)=>b.v-a.v);$(vs[0].el).classList.add('best-calc');}

window._c={co, coInput, debtBal, extraCash,dp,bal,mp,esc,hv,debtsPaidOff,remDebt,cur,hlR,hlT,hlP,hlTot,hlAll,hlS,hlL,hoR,hoT,hoP,hoTot,hoAll,hoS,hoL,cR,cT,cP,cTot,cAll,cS,cL,ccDollar,escDollar,ccRefiTot,vaFee,vaFeePct,fR,fT,fP,fTot,fAll,fS,fL,fB};
if(!dirty.email||!dirty.sms||!dirty.crm)out();
}

function getCnvName(){return $('vaOn').checked?'VA Refinance':'Conventional Refinance';}
function getCnvDesc(){return $('vaOn').checked?'Replaces your current mortgage with a new VA loan.':'Replaces your current mortgage with a new mortgage.';}

function pi(p,c){
if(p==='hln')return{n:'Fixed Rate Home Equity Loan',desc:'Adds a fixed second mortgage. Main mortgage stays the same.',r:c.hlR,t:c.hlT,pm:c.hlP,tot:c.hlTot,sv:c.hlS,la:c.hlL,is2nd:true,isHeloc:false};
if(p==='hlo')return{n:'HELOC',desc:'Adds a flexible credit line. Main mortgage stays the same.',r:c.hoR,t:c.hoT,pm:c.hoP,tot:c.hoTot,sv:c.hoS,la:c.hoL,is2nd:true,isHeloc:true};
if(p==='cnv')return{n:getCnvName(),desc:getCnvDesc(),r:c.cR,t:c.cT,pm:c.cP,tot:c.cTot,sv:c.cS,la:c.cL,is2nd:false,isHeloc:false};
if(p==='fha')return{n:'FHA Refinance',desc:'Replaces current mortgage with a new FHA loan.',r:c.fR,t:c.fT,pm:c.fP,tot:c.fTot,sv:c.fS,la:c.fL,is2nd:false,isHeloc:false};
return null;}

function out(){
const c=window._c||{},fullNm=$('cNm').value||'[Name]',nm=(getFirstName(fullNm)||fullNm)||'[Name]';
let chk=[];if($('chkHln').checked)chk.push('hln');if($('chkHlo').checked)chk.push('hlo');if($('chkCnv').checked)chk.push('cnv');if($('chkFha').checked)chk.push('fha');
if(chk.length===0)chk=['cnv'];
// Starred first
if(bestStar&&chk.includes(bestStar)){chk=chk.filter(k=>k!==bestStar);chk.unshift(bestStar);}

// Benefit sentence
const prods = chk.map(p => ({ k:p, ...pi(p,c) })).filter(p => p && p.tot > 0);
const bestP = prods[0] || null;

let bene = '';
if (bestP) {
  const sv = bestP.sv || 0;

  const hasDebtPayoff = (c.debtBal || 0) > 0;
  const hasCashOutInput = (c.coInput || 0) > 0;
  const hasExtra = (c.extraCash || 0) > 0;

  // Debt payoff + extra cash scenario (cashout > debts)
  if (sv > 0 && hasDebtPayoff && hasCashOutInput && hasExtra) {
    bene =
      'This plan gives you about ' + fd(c.debtBal) +
      ' to wipe out debt and another ' + fd(c.extraCash) +
      ' back in your pocket. It lowers your total monthly payments by about ' + fd(sv) +
      (bestP.is2nd ? ' - all without touching your current mortgage.' : ' - all under one simple fixed loan.');
  }
  // Debt payoff only (cashout blank but debts entered, OR cashout equals debts)
  else if (sv > 0 && hasDebtPayoff && (hasCashOutInput || !hasCashOutInput)) {
    bene =
      'This plan gives you about ' + fd(c.debtBal) +
      ' to wipe out debt and lowers your total monthly payments by about ' + fd(sv) +
      (bestP.is2nd ? ' - all without touching your current mortgage.' : ' - all under one simple fixed loan.');
  }
  // Cash out, no itemized debts
  else if (sv > 0 && (c.co || 0) > 0) {
    bene = 'This plan lowers your payment by about ' + fd(sv) + ' and puts about ' + fd(c.co) + ' back in your pocket.';
  }
  // Pure rate/term improvement
  else if (sv > 0) {
    bene = 'This plan lowers your monthly payments by about ' + fd(sv) + '.';
  }
  // Access to cash (no savings calc available)
  else if ((c.co || 0) > 0) {
    bene = 'This plan would give you access to roughly ' + fd(c.co) + '.';
  }
}

// === EMAIL ===
if(!dirty.email){
const multi=chk.filter(k=>{const p=pi(k,c);return p&&p.tot>0;}).length>1;
let e=[];
e.push('Hey '+nm+',');
e.push('');
if(multi)e.push('Good talking with you. Here’s what I mapped out based on what you told me.');
else e.push('Good talking with you. Here’s what I mapped out based on what you told me.');
if(bene){e.push('');e.push(bene);}
if(multi){
const has2=chk.some(k=>{const p=pi(k,c);return p&&p.is2nd;});
const hasR=chk.some(k=>{const p=pi(k,c);return p&&!p.is2nd;});
if(has2&&hasR){e.push('');e.push('The main difference between these options is whether we replace your current mortgage or leave it in place.');}
}
e.push('');

let optN=0;
chk.forEach(k=>{
const p=pi(k,c);if(!p||p.tot<=0)return;
optN++;
const rs=p.r>0?p.r.toFixed(3)+'%':'-';
const isBest=k===bestStar;
const bestTag=isBest?' (best overall option)':'';
const label=multi?'Option '+optN+' - ':'';

e.push(label+p.n+bestTag+' — '+p.desc);
e.push('');

if(p.isHeloc){
e.push('Rate: '+rs+' (variable based on the Prime Rate)');
e.push('Monthly payment (interest-only): '+fd(p.pm)+' + '+fd(c.mp)+' on your current mortgage');
e.push('Total monthly housing: '+fd(p.tot));
}else if(p.is2nd){
e.push('Rate: '+rs);
e.push('Term: '+p.t+'-year fixed');
e.push('Monthly payment: '+fd(p.pm)+' + '+fd(c.mp)+' on your current mortgage');
e.push('Total monthly housing: '+fd(p.tot));
}else{
e.push('Rate: '+rs);
e.push('Term: '+p.t+'-year fixed');
e.push('Monthly payment: '+fd(p.tot));
e.push('Skip 1 or 2 mortgage payments after closing');
}
e.push('$0 due at closing - closing costs are rolled into the new loan');
if(p.is2nd||p.isHeloc){}// no skip for 2nd
e.push('Takes about 2 weeks to complete');
e.push('');
});

e.push("These numbers are very close estimates. I’ll confirm exact figures once I review your full file.");
e.push('');
e.push('The only possible out-of-pocket cost would be the appraisal (usually around $600). We’ll confirm that upfront.');
e.push('');
e.push('If this looks in line with what we discussed, next step is to fill out the quick 5-minute form below so I can lock everything in:');
const lo=getLO();
  e.push(lo.app || '[Set your application link in LO Settings]');
e.push('');
e.push('It is a soft check only and will not affect your credit score.');
e.push('');
e.push('Text or call me anytime at '+(getLO().phone || '[Set your phone number in LO Settings]')+' if you want to walk through it together.');
$('dE').value=e.join('\n');
}

// === SMS ===
if(!dirty.sms){
$('dS').value='Hey '+nm+', this is '+(getLO().name||'your Loan Pronto team')+' from Loan Pronto! Just sent you an email with the numbers we walked through. When you get a minute, take a look and tell me your first impression. If it doesn’t show up, check spam or promotions. This is my direct phone number. ';
}

// === CRM (internal notes NEVER included per spec) ===
if(!dirty.crm){
let cr=[];cr.push('LEAD: '+nm);
const gl=$('cGl').value;if(gl)cr.push('Goals: '+gl);
const w2=$('cW2').value;if(w2)cr.push('Employment: '+w2);
if(c.hv>0)cr.push('Home Value: '+fd(c.hv));if(c.bal>0)cr.push('Mortgage Balance: '+fd(c.bal));
if(c.mp>0)cr.push('Current Payment: '+fd(c.mp)+' (escrow: '+fd(c.esc)+')');
if(c.co>0)cr.push('Cash Out: '+fd(c.co));if(c.dp>0)cr.push('Debt Payments: '+fd(c.dp));
const lv=c.hv>0?(c.bal/c.hv*100).toFixed(1)+'%':'-';cr.push('LTV: '+lv);
cr.push('','--- Products ---');
if(c.hlR>0)cr.push('HEL: '+c.hlR.toFixed(3)+'%/'+c.hlT+'yr | '+fd(c.hlTot)+'/mo | '+(c.hlS>0?'+':'')+fd(c.hlS));
if(c.hoR>0)cr.push('HELOC: '+c.hoR.toFixed(3)+'%/'+c.hoT+'yr | '+fd(c.hoTot)+'/mo | '+(c.hoS>0?'+':'')+fd(c.hoS));
if(c.cR>0)cr.push(getCnvName()+': '+c.cR.toFixed(3)+'%/'+c.cT+'yr | '+fd(c.cTot)+'/mo | '+(c.cS>0?'+':'')+fd(c.cS));
if(c.fR>0)cr.push('FHA: '+c.fR.toFixed(3)+'%/'+c.fT+'yr | '+fd(c.fTot)+'/mo | '+(c.fS>0?'+':'')+fd(c.fS));
if(c.ccRefiTot>0)cr.push('Closing Costs: '+fd(c.ccRefiTot));
if(c.vaFee>0)cr.push('VA Funding Fee: '+fd(c.vaFee));
const debts=getD().filter(d=>d.name);
if(debts.length>0)cr.push('','Debts: '+debts.map(d=>d.name+' '+fd(d.bal)+' ('+fd(d.pmt)+'/mo)').join(', '));
cr.push('','Pitched: '+chk.map(k=>{const p=pi(k,c);return p?p.n:'';}).join(' + '));
$('dC').value=cr.join('\n');
}}

function regen(){dirty={email:false,sms:false,crm:false};out();}

async function cpyCur(){const map={email:'dE',sms:'dS',crm:'dC'};const t=$(map[aTab]).value;try{await navigator.clipboard.writeText(t);}catch(e){const a=document.createElement('textarea');a.value=t;document.body.appendChild(a);a.select();document.execCommand('copy');document.body.removeChild(a);}const b=$('cpyBtn');b.classList.add('ok');b.textContent='Copied';setTimeout(()=>{b.classList.remove('ok');b.textContent='Copy';},1200);}

function openOutlook(){
  const em=$('cEm').value||'';
  const lo=getLO();
  const subj=encodeURIComponent('Your Loan Plan — '+(lo.name||'Loan Pronto')+' @ Loan Pronto');
  const body=encodeURIComponent($('dE').value);
  window.location.href='mailto:'+em+'?subject='+subj+'&body='+body;
}

function emailSelf(){
  const lo=getLO();
  if(!lo.email){
    toast('Set your Email to Myself in LO Info');
    openLO();
    try{ $('loEmail') && $('loEmail').focus(); }catch(e){}
    return;
  }
const c=window._c||{},nm=$('cNm').value||'[Name]',gl=$('cGl').value||'',w2=$('cW2').value||'',nt=$('cNt').value||'';
let s=[];s.push('ATLAS DEAL SUMMARY','========================','');
s.push('CLIENT: '+nm);
const em=$('cEm').value;if(em)s.push('Email: '+em);
if(gl)s.push('Goals: '+gl);if(w2)s.push('Employment: '+w2);
s.push('','PROPERTY & MORTGAGE');
s.push('Home Value: '+fd(c.hv));s.push('Mortgage Balance: '+fd(c.bal));
s.push('Current Payment (w/ escrow): '+fd(c.mp));s.push('Escrow/mo: '+fd(c.esc));
const lv=c.hv>0?(c.bal/c.hv*100).toFixed(1)+'%':'-',clv=c.hv>0?((c.bal+c.co)/c.hv*100).toFixed(1)+'%':'-';
s.push('LTV: '+lv+' | CLTV: '+clv);
s.push('','CASH & DEBT');s.push('Cash Out: '+fd(c.co));s.push('Monthly Debt Payments: '+fd(c.dp));
const debts=getD().filter(d=>d.name);
if(debts.length>0){s.push('');s.push('Itemized Debts:');debts.forEach(d=>s.push('  '+d.name+': '+fd(d.bal)+' bal, '+fd(d.pmt)+'/mo'));}
s.push('','LOAN OPTIONS','------------------------');
if(c.hlR>0){s.push('Fixed Rate Home Equity Loan');s.push('  Rate: '+c.hlR.toFixed(3)+'% | Term: '+c.hlT+'yr');s.push('  Loan: '+fd(c.hlL)+' | Pmt: '+fd(c.hlP));s.push('  Total Housing: '+fd(c.hlTot)+' | Savings: '+(c.hlS>0?'+':'')+fd(c.hlS)+'/mo');s.push('');}
if(c.hoR>0){s.push('HELOC');s.push('  Rate: '+c.hoR.toFixed(3)+'% | Term: '+c.hoT+'yr');s.push('  Loan: '+fd(c.hoL)+' | IO Pmt: '+fd(c.hoP));s.push('  Total Housing: '+fd(c.hoTot)+' | Savings: '+(c.hoS>0?'+':'')+fd(c.hoS)+'/mo');s.push('');}
if(c.cR>0){s.push(getCnvName());s.push('  Rate: '+c.cR.toFixed(3)+'% | Term: '+c.cT+'yr');s.push('  Loan: '+fd(c.cL)+' | P&I: '+fd(c.cP));s.push('  Total Pmt: '+fd(c.cTot)+' | Savings: '+(c.cS>0?'+':'')+fd(c.cS)+'/mo');if(c.vaFee>0)s.push('  VA Funding Fee: '+fd(c.vaFee));s.push('');}
if(c.fR>0){s.push('FHA Refinance');s.push('  Rate: '+c.fR.toFixed(3)+'% | Term: '+c.fT+'yr');s.push('  Loan: '+fd(c.fL)+' | P&I+MI: '+fd(c.fP));s.push('  Total Pmt: '+fd(c.fTot)+' | Savings: '+(c.fS>0?'+':'')+fd(c.fS)+'/mo');s.push('');}
s.push('CLOSING COSTS');s.push('Estimated CC: '+fd(c.ccDollar));s.push('Escrow Collection: '+fd(c.escDollar));s.push('Total (Refi): '+fd(c.ccRefiTot));
if(c.vaFee>0)s.push('VA Funding Fee: '+fd(c.vaFee)+' ('+c.vaFeePct.toFixed(2)+'%)');
if(nt){s.push('','INTERNAL NOTES');s.push(nt);}
let chk=[];if($('chkHln').checked)chk.push('hln');if($('chkHlo').checked)chk.push('hlo');if($('chkCnv').checked)chk.push('cnv');if($('chkFha').checked)chk.push('fha');
s.push('','Pitched: '+chk.map(k=>{const p=pi(k,c);return p?p.n:'';}).join(' + '));
window.location.href='mailto:'+lo.email+'?subject=' + encodeURIComponent('Atlas Summary: '+nm)+'&body='+encodeURIComponent(s.join('\n'));
}

loadLO();
rc();
</script>


<script>
(function(){
  function isEmailToSelfButton(el){
    if(!el) return false;
    const id = (el.id||"").toLowerCase();
    const cls = (el.className||"").toString().toLowerCase();
    const txt = (el.textContent||"").toLowerCase().trim();
    return id.includes("email") && id.includes("self")
      || cls.includes("email") && cls.includes("self")
      || txt === "email to myself"
      || txt === "email myself"
      || txt.includes("email to myself");
  }

  function findRecipientInput(){
    // Prefer explicit "to" fields
    const selectors = [
      'input[type="email"]#toEmail',
      'input[type="email"]#sendToEmail',
      'input[type="email"]#emailTo',
      'input[type="email"]#to',
      'input[type="email"][name="to"]',
      'input[type="email"][name*="to"]',
      'input[type="email"][id*="to"]',
      'input[type="email"][data-role="to"]'
    ];
    for(const sel of selectors){
      const el = document.querySelector(sel);
      if(el) return el;
    }

    // Fallback: look for email input inside an email composer/modal container if present
    const containers = [
      '#emailModal', '#emailPanel', '#emailComposer', '.email-modal', '.email-panel', '.email-composer'
    ];
    for(const csel of containers){
      const c = document.querySelector(csel);
      if(c){
        const el = c.querySelector('input[type="email"]');
        if(el) return el;
      }
    }

    // Last resort: do NOT touch the client email field (often labeled/placeholder "Client Email")
    // Pick the first email input that is NOT the client email by heuristic.
    const all = Array.from(document.querySelectorAll('input[type="email"]'));
    const filtered = all.filter(e=>{
      const pid = (e.id||"").toLowerCase();
      const pname = (e.name||"").toLowerCase();
      const ph = (e.placeholder||"").toLowerCase();
      const aria = (e.getAttribute('aria-label')||"").toLowerCase();
      const labelTxt = (e.closest('label')?.textContent||"").toLowerCase();
      // Exclude anything that looks like client/borrower email field
      const looksClient = pid.includes("client") || pname.includes("client") || ph.includes("client") || aria.includes("client") || labelTxt.includes("client");
      return !looksClient;
    });
    return filtered[0] || null;
  }

  document.addEventListener('click', function(ev){
    const btn = ev.target.closest('button, a, div');
    if(!isEmailToSelfButton(btn)) return;

    const to = findRecipientInput();
    if(to){
      to.value = (getLO().email || "");
      to.dispatchEvent(new Event('input', {bubbles:true}));
      to.dispatchEvent(new Event('change', {bubbles:true}));
    }
  }, true);
})();

/* === POWER KEYS + FORMAT + UNDO ENHANCEMENTS === */
(function(){
  const lastUpdEl = document.getElementById('lastUpd');
  let lastUpdTimer = null;

  function fmtTime(d){
    try{
      return d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
    }catch(e){
      const hh = d.getHours();
      const mm = String(d.getMinutes()).padStart(2,'0');
      const ampm = hh >= 12 ? 'PM' : 'AM';
      const h12 = ((hh + 11) % 12) + 1;
      return h12 + ':' + mm + ' ' + ampm;
    }
  }

  function touchUpdated(){
    if(!lastUpdEl) return;
    if(lastUpdTimer) clearTimeout(lastUpdTimer);
    lastUpdTimer = setTimeout(()=>{
      lastUpdEl.textContent = 'Updated: ' + fmtTime(new Date());
    }, 120);
  }

  // Toast
  let toastEl = null, toastTimer = null;
  function ensureToast(){
    if(toastEl) return toastEl;
    toastEl = document.createElement('div');
    toastEl.id = 'toast';
    toastEl.className = 'toast';
    toastEl.textContent = '';
    document.body.appendChild(toastEl);
    return toastEl;
  }
  function toast(msg){
    const el = ensureToast();
    el.textContent = msg;
    el.classList.add('on');
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ el.classList.remove('on'); }, 900);
  }

  // Utilities (parse "55k" / "1.2m" and normalize)
  function parseK(v){
    const s = String(v ?? '').trim().toLowerCase();
    if(!s) return null;
    const m = s.match(/^(-?\d+(?:\.\d+)?)\s*([km])$/i);
    if(m){
      const n = parseFloat(m[1]);
      const mult = m[2] === 'm' ? 1_000_000 : 1_000;
      return n * mult;
    }
    return null;
  }

  function asNumber(v){
    // prefer existing safeNum if present
    try{
      if(typeof safeNum === 'function') return safeNum(v);
    }catch(e){}
    const s = String(v ?? '').replace(/[^0-9.\-]/g,'');
    return parseFloat(s) || 0;
  }

  function fmtMoney(n){
    if(!isFinite(n)) return '';
    const sign = n < 0 ? '-' : '';
    const nn = Math.round(Math.abs(n));
    return sign + '$' + nn.toLocaleString('en-US');
  }

  function fmtPercent(n, maxDec=3){
    if(!isFinite(n)) return '';
    // keep up to maxDec, trim trailing zeros
    let s = Number(n).toFixed(maxDec);
    s = s.replace(/\.?0+$/,'');
    return s;
  }

  const moneyIds = new Set(['cHV','cBal','cMP','cEsc','cCO','cDP']);
  const moneyDataCols = new Set(['bal','pmt']);
  const percentIds = new Set(['hlnR','hloR','cnvR','fhaR','vaCustomPct']);
  const termIds = new Set(['hlnT','hloT','cnvT','fhaT']);

  function isMoneyField(el){
    if(!el || el.tagName !== 'INPUT') return false;
    if(moneyIds.has(el.id)) return true;
    const dc = el.getAttribute('data-col');
    if(dc && moneyDataCols.has(dc)) return true;
    return false;
  }

  function isPercentField(el){
    if(!el || el.tagName !== 'INPUT') return false;
    if(percentIds.has(el.id)) return true;
    // Closing cost % box only when cc mode is pct
    if(el.id === 'ccVal'){
      try{ return (typeof ccMode !== 'undefined' ? ccMode : 'pct') === 'pct'; }catch(e){ return true; }
    }
    return false;
  }

  function isTermField(el){
    if(!el || el.tagName !== 'INPUT') return false;
    return termIds.has(el.id);
  }

  function applyPrettyFormat(el){
    if(!el || el.tagName !== 'INPUT') return;

    const raw = el.value;
    if(!raw || !raw.trim()) return;

    // Shift held? (opt out) We store a flag on the element during keydown.
    if(el.dataset && el.dataset.skipFormat === '1'){
      el.dataset.skipFormat = '0';
      return;
    }

    // Allow "55k" / "1.2m" on money fields
    if(isMoneyField(el)){
      const k = parseK(raw);
      const n = (k !== null) ? k : asNumber(raw);
      if(n === 0 && raw.trim() !== '0') return; // don't force "$0" on random text
      el.value = fmtMoney(n);
      return;
    }

    if(isPercentField(el)){
      const n = asNumber(raw);
      el.value = fmtPercent(n, 3);
      return;
    }

    if(isTermField(el)){
      const n = asNumber(raw);
      if(n > 0) el.value = String(Math.round(n));
      return;
    }
  }

  // One-step undo
  const undoStack = [];
  function pushUndo(el, prevVal, nextVal){
    if(!el) return;
    // only track meaningful changes
    if(String(prevVal) === String(nextVal)) return;
    undoStack.push({ el, prevVal });
    // cap size
    if(undoStack.length > 80) undoStack.shift();
  }

  function doUndo(){
    while(undoStack.length){
      const it = undoStack.pop();
      if(!it || !it.el) continue;
      if(!document.body.contains(it.el)) continue; // element removed (e.g., debt row deleted)
      it.el.value = it.prevVal;
      // trigger recalcs
      try{
        it.el.dispatchEvent(new Event('input', {bubbles:true}));
        it.el.dispatchEvent(new Event('change', {bubbles:true}));
      }catch(e){}
      try{ if(typeof calcD === 'function') calcD(); }catch(e){}
      try{ if(typeof rc === 'function') rc(); }catch(e){}
      touchUpdated();
      toast('Undid last change');
      return;
    }
    toast('Nothing to undo');
  }

  // Focus / blur handlers (delegated so it works for dynamic debt rows)
  document.addEventListener('focusin', (e)=>{
    const el = e.target;
    if(!(el instanceof HTMLElement)) return;
    if(el.tagName === 'INPUT'){
      el.dataset.prevVal = el.value;
      // highlight for fast replace
      try{ el.select(); }catch(err){}
    }
  });

  document.addEventListener('keydown', (e)=>{
    // allow Shift+Tab etc; only set skipFormat for inputs when Shift is held
    const el = e.target;
    if(el && el.tagName === 'INPUT' && e.key === 'Shift'){
      el.dataset.skipFormat = '1';
    }
  }, true);

  document.addEventListener('focusout', (e)=>{
    const el = e.target;
    if(!(el instanceof HTMLElement)) return;

    if(el.tagName === 'INPUT'){
      const prev = el.dataset.prevVal ?? '';
      const next = el.value;
      // record undo BEFORE formatting changes the display
      if(prev !== next){
        pushUndo(el, prev, next);
      }
      applyPrettyFormat(el);

      // after formatting, recalc if needed
      if(el.closest && el.closest('#dB')){ try{ if(typeof calcD === 'function') calcD(); }catch(err){} }
      try{ if(typeof rc === 'function') rc(); }catch(err){}
      touchUpdated();
    }
  });

  // Update timestamp on non-draft inputs/changes
  document.addEventListener('input', (e)=>{
    const t = e.target;
    if(t && t.classList && t.classList.contains('draft')) return;
    touchUpdated();
  });

  // Debts: Enter-to-advance (delegated)
  const dB = document.getElementById('dB');
  if(dB){
    dB.addEventListener('keydown', (e)=>{
      if(e.key !== 'Enter') return;
      const el = e.target;
      if(!(el instanceof HTMLElement)) return;
      if(!(el.matches('input,select'))) return;
      e.preventDefault();

      const tr = el.closest('tr');
      if(!tr) return;

      const sel = tr.querySelector('select');
      const bal = tr.querySelector('input[data-col="bal"]');
      const pmt = tr.querySelector('input[data-col="pmt"]');

      // Move within row
      if(el === sel && bal){ bal.focus(); return; }
      if(el === bal && pmt){ pmt.focus(); return; }

      // From payment -> next row select (or create one)
      if(el === pmt){
        const nextTr = tr.nextElementSibling;
        if(nextTr){
          const nextSel = nextTr.querySelector('select');
          if(nextSel){ nextSel.focus(); return; }
        }
        // add row if we're at the end
        try{
          if(typeof addD === 'function') addD();
          if(typeof calcD === 'function') calcD();
        }catch(err){}
        const last = dB.lastElementChild;
        const lastSel = last ? last.querySelector('select') : null;
        if(lastSel) lastSel.focus();
      }
    });
  }

  // Power keys (Windows)
  function isTypingContext(target){
    if(!target) return false;
    const tag = target.tagName;
    if(tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return true;
    return !!target.isContentEditable;
  }

  function setTab(t){
    try{
      const tabEls = document.querySelectorAll('.tab');
      const map = { email: tabEls[0], sms: tabEls[1], crm: tabEls[2] };
      if(map[t]) map[t].click();
    }catch(e){}
  }

  async function copyFromDraft(tab){
    setTab(tab);
    let val = '';
    try{
      if(tab === 'email') val = document.getElementById('dE')?.value || '';
      if(tab === 'sms') val = document.getElementById('dS')?.value || '';
      if(tab === 'crm') val = document.getElementById('dC')?.value || '';
    }catch(e){}
    if(!val.trim()){ toast('Nothing to copy'); return; }
    try{
      await navigator.clipboard.writeText(val);
      toast(`Copied ${tab.toUpperCase()}`);
    }catch(e){
      // fallback
      try{
        const ta = document.createElement('textarea');
        ta.value = val;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        toast(`Copied ${tab.toUpperCase()}`);
      }catch(err){
        toast('Copy failed');
      }
    }
  }

  function focusCashOut(){
    const el = document.getElementById('cCO');
    if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); el.focus(); }
  }

  function focusDebts(){
    const container = document.querySelector('.bc .dt')?.closest('.bc') || document.querySelector('.dt')?.closest('.bc');
    if(container){ container.scrollIntoView({behavior:'smooth', block:'center'}); }
    const firstSel = document.querySelector('#dB tr select');
    if(firstSel){ firstSel.focus(); return; }
    // If no rows exist, add one
    try{
      if(typeof addD === 'function') addD();
      if(typeof calcD === 'function') calcD();
    }catch(e){}
    const sel = document.querySelector('#dB tr select');
    if(sel) sel.focus();
  }

  document.addEventListener('keydown', (e)=>{
    if(!e.altKey) return;

    const k = (e.key || '').toLowerCase();

    // We allow these even while typing because they are Alt-combos (shouldn't insert text),
    // but we still avoid hijacking if user is in a textarea draft.
    const tgt = e.target;
    const inDraft = tgt && tgt.classList && tgt.classList.contains('draft');
    if(inDraft) return;

    if(k === '1'){ e.preventDefault(); copyFromDraft('email'); return; }
    if(k === '2'){ e.preventDefault(); copyFromDraft('sms'); return; }
    if(k === '3'){ e.preventDefault(); copyFromDraft('crm'); return; }

    if(k === 'c'){ e.preventDefault(); try{ if(typeof openOutlook === 'function') openOutlook(); }catch(err){} toast('Email to Client'); return; }
    if(k === 'm'){ e.preventDefault(); try{ if(typeof emailSelf === 'function') emailSelf(); }catch(err){} toast('Email to Myself'); return; }
    if(k === 'r'){ e.preventDefault(); try{ if(typeof regen === 'function') regen(); }catch(err){} toast('Regenerated'); return; }
    if(k === 'n'){ e.preventDefault(); try{ if(typeof newCall === 'function') newCall(); }catch(err){} touchUpdated(); toast('New Call'); return; }
    if(k === 'z'){ e.preventDefault(); doUndo(); return; }
    if(k === '/'){ e.preventDefault(); focusCashOut(); return; }
    if(k === 'd'){ e.preventDefault(); focusDebts(); return; }
  });

  // Initialize timestamp immediately (helps on load)
  touchUpdated();

  // LO Settings link (footer)
  const _loLink = $("loLink");
  if(_loLink){
    _loLink.addEventListener("click", (ev)=>{ ev.preventDefault(); openLO(); });
  }
  // close modal when clicking outside the card
  const _loModal = $("loModal");
  if(_loModal){
    _loModal.addEventListener("click", (ev)=>{ if(ev.target===_loModal) closeLO(); });
  }
})();

</script>


<div class="atlasver"><span>Atlas v1</span> <span class="dot">•</span> <a href="#" id="loLink">LO Settings</a></div>

<div id="loModal" class="modal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="loTitle">
    <div class="modalHd">
      <div class="t" id="loTitle">LO Settings</div>
      <button class="x" type="button" onclick="closeLO()">Close</button>
    </div>
    <div class="modalNote">Saved on this device. Enter once and you’re done.</div>
    <div class="modalGrid">
      <div class="row"><span class="lbl">Your Name</span><input class="inp" id="loName" placeholder="Harry Carwile" oninput="saveLO(true);rc();"></div>
      <div class="row"><span class="lbl">Your Phone</span><input class="inp" id="loPhone" placeholder="704-307-4482" oninput="saveLO(true);rc();"></div>
      <div class="row"><span class="lbl">Your Application Link</span><input class="inp" id="loApp" placeholder="https://harrycarwile.my1003app.com/register" oninput="saveLO(true);rc();"></div>
      <div class="row"><span class="lbl">Email to Myself</span><input class="inp" id="loEmail" type="email" placeholder="harry@loanpronto.com" oninput="saveLO(true);"></div>
    </div>
  </div>
</div>

</body></html>